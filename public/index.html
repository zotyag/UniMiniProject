<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Viccelek</title>
    <link rel="stylesheet" href="css/main.css">
    <link rel="icon" type="image/png" href="/favicon.png">
</head>

<body>

    <div class="banner">

        <div class="banner-img"></div>

        <h1 class="title">Viccelek</h1>

        <div id="navbar">
            <div class="user-info">
                <div>Username: <span id="logged-in-user">TesztElek13</span></div>
                <button id="btn-logout">Logout</button>
                <button id="menu-toggle-btn" onclick="myFunc()">☰</button>
            </div>

            <div id="nav-menu">
                <div class="nav-item">
                    <div class="nav-item-text">Home</div>
                </div>
                <div class="nav-item">
                    <div class="nav-item-text">About</div>
                </div>
                <div class="nav-item">
                    <div class="nav-item-text">Rules</div>
                </div>
            </div>



        </div>
    </div>
    <main>
        <div id="posts">
            <div id="filter">
                <Label>Sort:</Label>
                <button>Time</button>
                <button>Popularity</button>
                <button id="new_post">New post</button>
            </div>


            <div class="post">
                <div class="header">
                    <div class="author">
                        <div class="author-name">John</div>
                        <div class="time-of-post">2020/04/12</div>
                    </div>
                    <button class="btn-delete">delete</button>
                </div>
                <div class="joke">
                    <div class="rating">
                        <button>&#x2B9D;</button>
                        <div class="rating-value">0</div>
                        <button>&#x2B9F;</button>
                    </div>
                    <textarea>This is a joke!</textarea>
                </div>
            </div>
            <div class="post">
                <div class="header">
                    <div class="author">
                        <div class="author-name">John</div>
                        <div class="time-of-post">2020/04/12</div>
                    </div>
                    <button class="btn-delete">delete</button>
                </div>
                <div class="joke">
                    <div class="rating">
                        <button>&#x2B9D;</button>
                        <div class="rating-value">0</div>
                        <button>&#x2B9F;</button>
                    </div>
                    <textarea>This is a joke!</textarea>
                </div>
            </div>
            <div class="post">
                <div class="header">
                    <div class="author">
                        <div class="author-name">John</div>
                        <div class="time-of-post">2020/04/12</div>
                    </div>
                    <button class="btn-delete">delete</button>
                </div>
                <div class="joke">
                    <div class="rating">
                        <button>&#x2B9D;</button>
                        <div class="rating-value">0</div>
                        <button>&#x2B9F;</button>
                    </div>
                    <textarea>This is a joke!</textarea>
                </div>
            </div>
            <div class="post">
                <div class="header">
                    <div class="author">
                        <div class="author-name">John</div>
                        <div class="time-of-post">2020/04/12</div>
                    </div>
                    <button class="btn-delete">delete</button>
                </div>
                <div class="joke">
                    <div class="rating">
                        <button>&#x2B9D;</button>
                        <div class="rating-value">0</div>
                        <button>&#x2B9F;</button>
                    </div>
                    <textarea>This is a joke!</textarea>
                </div>
            </div>
            <div class="post">
                <div class="header">
                    <div class="author">
                        <div class="author-name">John</div>
                        <div class="time-of-post">2020/04/12</div>
                    </div>
                    <button class="btn-delete">delete</button>
                </div>
                <div class="joke">
                    <div class="rating">
                        <button>&#x2B9D;</button>
                        <div class="rating-value">0</div>
                        <button>&#x2B9F;</button>
                    </div>
                    <textarea>This is a joke!</textarea>
                </div>
            </div>


        </div>
        <div id="sentinel" style="height: 1px;"></div>
    </main>


    <script>
        function myFunc() {
            var a = document.getElementById('nav-menu')

            if (a.style.display == 'none')
                a.style.display = "block";
            else
                a.style.display = "none";

        }
    </script>

    <script>

    // Pagination client state
const pageSize = 100;
let currentPage = 0;
let currentSort = 'date'; // or 'popularity'
let loading = false;
let hasMore = true;

// Server fetch for a single page
async function fetchPosts(sort = currentSort, page = currentPage, limit = pageSize) {
  const res = await fetch(`/api/posts?sort=${encodeURIComponent(sort)}&page=${page}&limit=${limit}`);
  if (!res.ok) throw new Error('Failed to load posts');
  // Expected shape: { posts, hasMore, total, currentPage, totalPages, limit }
  return await res.json();
}


async function loadPostsIntoTable(initial = false) {
  if (loading || (!hasMore && !initial)) return;
  loading = true;

  if (initial) {
    document.getElementById('posts').innerHTML = '';
    currentPage = 0;
    hasMore = true;
  }

  const { posts, hasMore: more } = await fetchPosts(currentSort, currentPage, pageSize);

  posts.forEach(post => {
    add(post.id, post.author, post.created_at, post.content, post.popularity);
  });

  hasMore = more;
  currentPage += 1;
  loading = false;
}

const sentinel = document.getElementById('sentinel');
if (sentinel) {
  const io = new IntersectionObserver(entries => {
    if (entries[0].isIntersecting) {
      loadPostsIntoTable(false);
    }
  }, { rootMargin: '400px' });
  io.observe(sentinel);
}

window.addEventListener('DOMContentLoaded', () => loadPostsIntoTable(true));

    async function add(jokeId, author, created_at, text, rating) {
        // 1. Megkeressük a fő konténert
        const postsContainer = document.getElementById('posts');


        // 2. Létrehozzuk a <div class="post"> elemet
        const postDiv = document.createElement('div');
        postDiv.classList.add('post');

        // 3. Létrehozzuk a <div class="header"> elemet
        const headerDiv = document.createElement('div');
        headerDiv.classList.add('header');

        // 4. Létrehozzuk a <div class="author"> elemet
        const authorDiv = document.createElement('div');
        authorDiv.classList.add('author');

        // 5. Létrehozzuk a <div class="author-name"> elemet
        const authorNameDiv = document.createElement('div');
        authorNameDiv.classList.add('author-name');
        authorNameDiv.textContent = author; // Alapértelmezett érték beállítása

        // 6. Létrehozzuk a <div class="time-of-post"> elemet
        const timeOfPostDiv = document.createElement('div');
        timeOfPostDiv.classList.add('time-of-post');

const dateObj = new Date(created_at);
const year = dateObj.getUTCFullYear();
const month = dateObj.getUTCMonth() + 1;
const day = dateObj.getUTCDate(); // was getUTCDay()
const hours = dateObj.getUTCHours();
const min = dateObj.getUTCMinutes();
const sec = dateObj.getUTCSeconds();
const pad = (num) => String(num).padStart(2, '0');

const formattedDate = `${year}-${pad(month)}-${pad(day)} ${pad(hours)}:${pad(min)}:${pad(sec)}`;
timeOfPostDiv.textContent = formattedDate;


        // 7. Létrehozzuk a <button class="btn-delete"> elemet
        const deleteButton = document.createElement('button');
        deleteButton.classList.add('btn-delete');
        deleteButton.textContent = 'delete';
        deleteButton.addEventListener('click', () => {
            deletePost(jokeId)
        })

        // 8. Létrehozzuk a <div class="joke"> elemet
        const jokeDiv = document.createElement('div');
        jokeDiv.classList.add('joke');

        // 9. Létrehozzuk a <div class="rating"> elemet
        const ratingDiv = document.createElement('div');
        ratingDiv.classList.add('rating');

        // 10. Létrehozzuk a lájk gombot (fel)
        const upButton = document.createElement('button');
        upButton.innerHTML = '&#x2B9D;'; // Fel nyíl
        upButton.addEventListener('click', () => {
            ratePost(jokeId, 1);
        })

        // 11. Létrehozzuk a <div class="rating-value"> elemet
        const ratingValueDiv = document.createElement('div');
        ratingValueDiv.classList.add('rating-value');
        ratingValueDiv.textContent = rating; // Alapértelmezett érték beállítása

        // 12. Létrehozzuk a diszlájk gombot (le)
        const downButton = document.createElement('button');
        downButton.innerHTML = '&#x2B9F;'; // Le nyíl
        downButton.addEventListener('click', () => {
            ratePost(jokeId, -1);
        })

        // 13. Létrehozzuk a <textarea> elemet
        // const jokeTextarea = document.createElement('textarea');
        // jokeTextarea.textContent = text; // Alapértelmezett érték beállítása

        const jokeTextarea = document.createElement('p');
        jokeTextarea.classList.add('joke-text')
        jokeTextarea.textContent = text;



        // --- ÖSSZEFŰZÉS (Hierarchia felépítése) ---

        // author-name és time-of-post az author-ba
        authorDiv.appendChild(authorNameDiv);
        authorDiv.appendChild(timeOfPostDiv);

        // author és btn-delete a header-be
        headerDiv.appendChild(authorDiv);
        headerDiv.appendChild(deleteButton);

        // lájk gomb, rating-value, diszlájk gomb a rating-be
        ratingDiv.appendChild(upButton);
        ratingDiv.appendChild(ratingValueDiv);
        ratingDiv.appendChild(downButton);

        // rating és textarea a joke-ba
        jokeDiv.appendChild(ratingDiv);
        jokeDiv.appendChild(jokeTextarea);

        // header és joke a post-ba
        postDiv.appendChild(headerDiv);
        postDiv.appendChild(jokeDiv);

        // A kész post a posts konténerbe
        postsContainer.appendChild(postDiv);
    }
</script>
</body>

</html>