<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home</title>
    <link rel="stylesheet" href="css/main.css">
    <link rel="icon" type="image/png" href="/favicon.png">

</head>

<body>
    <div class="banner">
        <div class="banner-img"></div>
        <div id="navbar">
            <div class="user-info">
                <div id="logged-in-user">Username: <span id="logged-in-user-name">TesztElek13</span></div>
                <button onclick="userLoggedIn()" id="btn-login">Login</button>
                <button id="menu-toggle-btn" onclick="toggleNavMenuCollapse()">â˜°</button>
            </div>
            <div id="nav-menu">
                <div class="nav-item">
                    <div class="nav-item-text"><a href="index.html">Home</a></div>
                </div>
                <div class="nav-item">
                    <div class="nav-item-text"><a href="about.html">About</a></div>
                </div>
                <div class="nav-item">
                    <div class="nav-item-text"><a href="rules.html">Rules</a></div>
                </div>
            </div>
        </div>
    </div>
    <main>
        <div id="filter">
            <label>Sort:</label>
            <button id="btn-sort-time" aria-pressed="true">Time</button>
            <button id="btn-sort-pop" aria-pressed="false">Popularity</button>
            <button id="new_post">New post</button>
        </div>
        <div id="posts">

        </div>
        <div id="sentinel" style="height: 1px;"></div>
    </main>


    
    <script src="js/getCurrentUserData.js"></script>
    <script src="js/login.js"></script>
    <script src="js/deletePost.js"></script>

    <script>
        window.onload = userLoggedIn();

        async function userLoggedIn() {


            const user_info = await getCurrentUserData()
            // if user logged in
            if (user_info.uname != undefined) {
                const user_name_field = document.getElementById('logged-in-user');
                const user_name_value = document.getElementById('logged-in-user-name');
                const new_post_btn = document.getElementById('new_post');

                user_name_value.textContent = user_info.uname;
                user_name_field.style.display = "block"
                new_post_btn.style.display = 'block';


                const postsContainer = document.getElementById('posts');
                if (user_info.role === 'admin') {
                    postsContainer.classList.add('is-admin');
                } else {
                    postsContainer.classList.remove('is-admin');
                }

                const btn_login = document.getElementById('btn-login');
                btn_login.textContent = "logout"
                btn_login.addEventListener('click', async () => {
                    logout();
                })
            } else { // if user logged out
                const btn_login = document.getElementById('btn-login');
                const user_name_field = document.getElementById('logged-in-user').style.display = 'none';
                const user_name_value = document.getElementById('logged-in-user-name').textContent = "not logged in";
                const new_post_btn = document.getElementById('new_post');

                new_post_btn.style.display = 'none';


                const postsContainer = document.getElementById('posts').classList.remove('is-admin');

                btn_login.textContent = "login"
                btn_login.addEventListener('click', async () => {
                    document.location.href = "login.html";
                })
            }

        }

        function toggleNavMenuCollapse() {
            var a = document.getElementById('nav-menu');
            if (a.style.display === 'none') {
                a.style.display = 'block';
            } else {
                a.style.display = 'none';
            }
        }

        // Reset scrollbar to top on page load
        window.addEventListener('DOMContentLoaded', () => {
            window.scrollTo(0, 0); // Scroll to top
            loadPostsIntoTable(true);
        });
    </script>

    <script src="js/ratePost.js" defer></script>
    <script src="js/scroll.js" defer></script>

    <script>
        //Refresh when lik or dislike
        document.addEventListener('click', async (e) => {
            const btn = e.target.closest('.rate-btn');
            if (!btn) return;

            const jokeId = btn.dataset.jokeId;
            const value = parseInt(btn.dataset.value, 10);

            if (value !== 1 && value !== -1) return;

            await ratePost(jokeId, value);
        });
    </script>

    <script src="js/new_post.js"></script>
    <script src="js/render_post_box.js"></script>


</body>
</html>